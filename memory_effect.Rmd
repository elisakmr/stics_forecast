---
title: "Memory effect"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE, echo=FALSE}

dir_data <- "D:/HOME/ekamir/scoring_medscope/data/stics" 
dir_plot <- "D:/HOME/ekamir/scoring_medscope/figure" 

library(plyr)
library(dplyr)
library(tidyverse)
library(stats)

no_core <- 6

```

## Parameters 

```{r }

# bootstrap
load(file = file.path(dir_data, "extract", "nboot.RData"))


# variables
load(file = file.path(dir_data, "extract", "indicateurs.RData"))
load(file = file.path(dir_data, "extract", "temporalite.RData"))
indicateur <- indicateurs[5]
temporalite <- temporalite[5]

# runs
run <- seq(from=1, to=25, by=1)
nrun <- length(run)

# temporal agregation
temp <- 9:20 # length of agregation
agreg_type <- sum # type of agregation
ntemp <- length(temp)

# automatic parameters
nom_clim <- paste0(indicateur,1,"_clim_uerra5.RData")
load(file = file.path(dir_data, "extract", nom_clim))
ngrids <- dim(array_clim)[1]
nan <- dim(array_clim)[2]
nrun <- dim(array_clim)[3]
an <- seq(1993,2016,1)

```

## Loading and shaping data

```{r }

### LOADING ###


                                            ### WITH TIME DIMENSION ###
if (temporalite=="quinzaine"){

clim_original <- array(NA, dim=c(ngrids, nan, nrun, ntemp))
ref_original <- array(NA, dim=c(ngrids, nan, ntemp))

 for (year in an){
 y <- which(an==year)

       # bootstrap iteration index of the year selected
    load(file = file.path(dir_data, "extract", "rand_years.RData")) # list of years in each bootstrap iteration
     
    list_match <- lapply(rand_year, function(x) which(year == x)) # list of matchs between list of years randomly generated for the bootstrap and the year we are interested in
     
     y_index <- list_match[[1]] # year index within the bootstrap iteration
     b_index <- 1 # bootstrap iteration index
     for (b in 1:(nboot-1)){ # pick the first iteration and first index matching the year we are looking for
       if (length(list_match[[b]])<1 & length(y_index)<1) {y_index <- list_match[[b+1]]; b_index <- b+1}
       else {y_index <- y_index; b_index <- b_index}
     }
     
  nom_clim <- paste0(indicateur,b_index,"_clim_uerra5.RData")
  load(file = file.path(dir_data, "extract", nom_clim))
  clim_original[,y,,] <- array_clim[,y_index[1],,temp]
  
  nom_ref <- paste0(indicateur,b_index,"_ref_uerra5.RData")
  load(file = file.path(dir_data, "extract", nom_ref))
  ref_original[,y,] <- array_obs[,y_index[1],temp]
}


                                            ### WITHOUT TIME DIMENSION ###
} else if (temporalite=="yearly"){


clim_original <- array(NA, dim=c(ngrids, nan, nrun))
ref_original <- array(NA, dim=c(ngrids, nan))

 for (year in an){
 y <- which(an==year)

       # bootstrap iteration index of the year selected
    load(file = file.path(dir_data, "extract", "years.RData")) # list of years in each bootstrap iteration
     
    list_match <- lapply(rand_year, function(x) which(year == x)) # list of matchs between list of years randomly generated for the bootstrap and the year we are interested in
     
     y_index <- list_match[[1]] # year index within the bootstrap iteration
     b_index <- 1 # bootstrap iteration index
     for (b in 1:(nboot-1)){ # pick the first iteration and first index matching the year we are looking for
       if (length(list_match[[b]])<1 & length(y_index)<1) {y_index <- list_match[[b+1]]; b_index <- b+1}
       else {y_index <- y_index; b_index <- b_index}
     }
     
  nom_clim <- paste0(indicateur,b_index,"_clim_uerra5.RData")
  load(file = file.path(dir_data, "extract", nom_clim))
  clim_original[,y,] <- array_clim[,y_index[1],]
  
  nom_ref <- paste0(indicateur,b_index,"_ref_uerra5.RData")
  load(file = file.path(dir_data, "extract", nom_ref))
  ref_original[,y] <- array_obs[,y_index[1]]
}

}

ngrids <- dim(ref_original)[1]




### RESHAPING ###

# we build a 3 columns data frame: grid, year, value

df_out <- data.frame()

for (mb in 1:nrun){
  if (temporalite=="yearly"){
    int <- as.data.frame(clim_original[,,mb])
  }else if (temporalite=="monthly"){ 
    int <- as.data.frame(apply(clim_original[,,mb,], c(1,2), agreg_type))}
    colnames(int) <- an
    int <- int %>% gather(an) %>% mutate(maille=rep(seq(1,ngrids,1), times=nan))
    df_out <- rbind(df_out, int)
}


```

## Implementing ANOVA

```{r }

fit <- aov(data = df_out, formula = value ~ an + maille + an:maille)
summary(fit)

```

## Exploration plots

```{r }

par(mfrow=c(1,2))
boxplot(log(value) ~ an, data=df_out, cex.lab=1.5, xlab="year",ylab="log(value)")
boxplot(log(value) ~ maille, data=df_out, cex.lab=1.5, xlab="maille",ylab="log(value)")
# interactions: boxplot(log(value) ~ an*maille, data=df_out, cex.lab=1.5, xlab="combinaison annee et maille ",ylab="log(value)")


with(df_out, {interaction.plot(x.factor = maille, trace.factor=an, response = value, type="l", fun=mean)},
abline(h=mean(value[an==2002]),col="red"))
```

## Verification plots

```{r }

fit <- aov(data = df_out, formula= value ~ an+maille)
plot(fit)


```



