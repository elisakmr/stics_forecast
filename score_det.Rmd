---
title: "Deterministic scoring"
output: html_document
---

```{r setup, include=FALSE}
dir_data <- "D:/HOME/ekamir/scoring_medscope/data/stics" 
dir_plot <- "D:/HOME/ekamir/scoring_medscope/figure" 

library(dplyr)
library(tidyverse)
library(plyr)
library(easyVerification)
library(verification)
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
library(readr)

no_core <- 6
quinzn <- 9:20 # selected quinzaines de [9;20]
```

                                            ### GRIDDED ###
                                            
                                            
## Gridded scores

Scores computed for each grid separately.
Indicators are assessed on a 28 days time window and over the whole season

```{r}

indicatOrs <- c("grassyieldC1C2_", "bilanhydr")

tictoc::tic()

acc <- vector()
msess <- vector()

for (indicateur in indicatOrs){

  cl <- makeCluster(no_core)
  registerDoParallel(cl)

  foreach(b=1:nboot, .packages=c('easyVerification', 's2dverification')) %dopar%  { # loop on bootstrap samples
  #Spearman <- easyVerification:::EnsCorr
    
    nom_ref <- paste0(indicateur,b,"_ref.RData")
    nom_prev <- paste0(indicateur,b,"_prev.RData")
    nom_clim <- paste0(indicateur,b,"_clim.RData")
    nom_an_prev <- paste0(indicateur,b,"_anomaly_prev.RData")
    nom_an_obs <- paste0(indicateur,b,"_anomaly_obs.RData")
    
    load(file = file.path(dir_data, "extract", nom_ref))
    load(file = file.path(dir_data, "extract", nom_prev))
    load(file = file.path(dir_data, "extract", nom_clim))
    load(file = file.path(dir_data, "extract", nom_an_prev))
    load(file = file.path(dir_data, "extract", nom_an_obs))
    
    ngrids <- dim(array_obs)[1]
    #ndimT <- dim(array_obs)[3]
    

                                            ### SEASONAL ###
    
    
    # BE CAREFUL ON AGREGATION METHOD!!!!
    det_seas <- array(NA, dim = c(ngrids,3))
  if (indicateur=="bilanhydr"){
    prev_seas <- apply(array_prev[,,,quinzn], c(1,2,3), sum) #### aggregation method to be changed!!
    clim_seas <- apply(array_clim[,,,quinzn], c(1,2,3), sum)
    ref_seas <- apply(array_obs[,,quinzn], c(1,2), sum)
  }
    else { prev_seas <- array_prev; clim_seas <- array_clim; ref_seas <- array_obs}
    
   
      # MSESS & ACC
    msess <- veriApply("EnsMsess", fcst=prev_seas, fcst.ref=clim_seas, obs=ref_seas, parallel = TRUE)
    acc <- veriApply("EnsCorr", fcst=prev_anomaly, obs=obs_anomaly, parallel = TRUE)
    det_seas <- array(c(msess, acc), dim=c(ngrids,2))
    
    nom_prevseas <- paste0(indicateur, b,"scoredetseas_grid_prev.RData")
  
    save(det_seas, file = file.path(dir_data, "score", nom_prevseas))
  

}
stopCluster(cl)

}
tictoc::toc() 



```

  
                                            ### BOX SCORES ###
                                            
                                            
## Aggregated scores

Scores computed for each grid separately.
Indicators are assessed on a 28 days time window and over the whole season

```{r}
indicatOrs <- c("grassyieldC1C2_", "bilanhydr")

coeff <- vector()
seas_ps <- matrix(ncol = 2, nrow = 6)

for (indicateur in indicatOrs){
  load(file = file.path(dir_data, "extract", paste0("lat_",indicateur,".RData")))
  boot_month <- list()
  boot_seas <- list()

  for(b in 1:nboot)   {
    # loading gridded scores
  
    # seasonal
    nom_prevseas <- paste0(indicateur, b,"scoredetseas_grid_prev.RData")
    load(file = file.path(dir_data, "score", nom_prevseas))
    ngrids <- dim(det_seas)[1]

    val_prevseas <- list()
  
    for (i in 1:ngrids){
      val_prevseas[[i]] <- det_seas[i,]*cos(pi*lat[i]/180)
      coeff[i] <- cos(pi*lat[i]/180)
      # removing NAs
      if (length(which(is.na(det_seas[i,])))>0){
        coeff[i] <- NA
        val_prevseas[[i]] <- rep(NA,2)
      }
    }
  
    boot_seas[[b]] <- apply(array(unlist(val_prevseas) , c(2,ngrids)), 1, sum, na.rm = T)/sum(coeff, na.rm = T)
  }
  
    nom_bootseas <- paste0(indicateur, "seasdet_boot.csv")
    save(boot_seas, file = file.path(dir_data, "score", nom_bootseas))
    
    seas_ps <- apply(array(unlist(boot_seas) , c(2,nboot)), 1, mean, na.rm=T)
    nom_meanseas <- paste0(indicateur, "seasdet_box_prev.csv")
    write_csv(as.data.frame(seas_ps), file.path(dir_data, "score", nom_meanseas))

}

```


## Box score significance test

Wilcoxon test with H0: MSESS non supérieure à 0 + ACC non supérieur à 0.3

```{r}
indicateur <- "ET"
indicateur <- "DRAIN"

   # season
  nom_bootseas <- paste0(indicateur, "seasdet_boot.csv")
  load(file = file.path(dir_data, "score", nom_bootseas))

  boxboot <- array(unlist(boot_seas) , c(2,nboot))
  
  wilcox.test(boxboot[1,], mu = 0, alternative = "greater", conf.level = 0.95, na.action = na.omit)$p.value # msess
  wilcox.test(boxboot[2,], mu = 0.3, alternative = "greater", conf.level = 0.95, na.action = na.omit)$p.value # acc


```
