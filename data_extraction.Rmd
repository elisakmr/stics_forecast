---
title: "data_extraction"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
dir_data <- "D:/HOME/ekamir/scoring_medscope/data/emmah" 
dir_plot <- "D:/HOME/ekamir/scoring_medscope/figure" 

library(plyr)
library(dplyr)
library(tidyverse)
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
no_core <- 6
nboot <- 100
```

## Loading data aggregated in csv file

This section gathers parameters to be specified beforehand.
Binding the csv's

```{r data loading, echo=FALSE}
raw_stics <- read.csv(file = file.path(dir_data, "Extract_STICS-KCETP_Indicators_FR8_crau35_1993_2016.csv"), header = TRUE, sep = ",")
data_an <- raw_stics %>% filter(indicator=="RENDEMENT") 
data_period <- raw_stics %>% filter(!indicator=="RENDEMENT")

```

## Extracting parameters from csv to be used further

List of indicators, years, temporal dimension (number of indicator values per year)

```{r indicators, echo=FALSE}
# all crops included
an <- unique(raw_stics[,"year_"])
nan <- length(an)
ngrids <- length(unique(raw_stics[,"cellnum"]))
nrun <- length(unique(raw_stics[,"climatscenario"]))-1

  ### annual : un seul indicateur = rendement

# indic_an <- unique(data_an[,"indicator"])
# nindic_an <- length(indic_an)
# dimT_an <- unique(data_an[,"period"]) 
# ndimT_prairie <- length(dimT_prairie)
cult_an <- unique(data_an[,"occupsol"]) 
ncult_an <- length(cult_an)
ngrids_an <- length(unique(data_an[,"cellnum"]))
coupe<-c("C1","C2","C3")

  ### periodic

indic_period <- unique(data_period[,"indicator"])
nindic_period <- length(indic_period)
cult_period <- unique(data_period[,"occupsol"]) 
ncult_period <- length(cult_period)
dimT_period <- unique(data_period[,"period"]) 
ndimT_period <- length(dimT_period)

```

## Extracting annual indicator values = CEREAL YIELDS

For each indicator, values are stored in 3 multi-dimensional arrays: one per climat type (reference, prevision, climatology)
Reference array has 3 dimension: grid+year+t
Prevision/climatology arrays have 4 dimensions: grid+year+run+t
Grass: t= year,c1,c2,c3
All other cereals: t= year

```{r, echo=FALSE}

# generate random year series
# rand_year <- list()
# for (b in 1:nboot){
#    rand_year[[b]] <- sample(1:nan, nan, replace = TRUE) 
#  }
#  save(rand_year, file = file.path(dir_data, "extract", "years.RData"))

# array setting x*year(*run)*t
load(file = file.path(dir_data, "extract", "years.RData"))

tictoc::tic() 

                                           ####################### ANNUAL #######################

for (culture in cult_an){

   # culture type filtering
      cult_data <- data_an %>% 
        filter(occupsol == culture)
      
      ngrids_cult <- length(unique(cult_data[,"cellnum"]))
        # climat type filtering
      obs_data <- cult_data %>% 
        filter(climattype == "REF") 
      
      prev_data <- cult_data %>% 
        filter(climattype == "PS") 
      
      clim_data <- cult_data %>% 
        filter(climattype == "CLIMATO") 
      
  ifelse (culture == "GRASS", tempo<-4, tempo<-1) # temporal dimension depends on culture type
  coupe <- unique(data_an[,"period"])
  
  # extracting data
  cl <- makeCluster(no_core)
  registerDoParallel(cl)
  
  foreach(b=1:nboot, .packages="tidyverse") %dopar%  { # loop on bootstrap samples
    array_obs <- array(NA, dim=c(ngrids_cult, nan, tempo))
    array_prev <- array(NA, dim=c(ngrids_cult, nan, nrun, tempo))
    array_clim <- array(NA, dim=c(ngrids_cult, nan, nrun, tempo))
  
      for (j in 1:nan){
        y <- rand_year[[b]][j]
        
        obs_int <- obs_data %>% 
        filter(year_ == y) 
        prev_int1 <- prev_data %>% 
        filter(year_ == y) 
        clim_int1 <- clim_data %>% 
        filter(year_ == y) 
        
        for (t in tempo){
          array_obs[,j,t] <- as.vector(unlist(obs_int %>% filter(period == coupe[t]) %>% select(indicatorvalue)))
          
          prev_int2 <- prev_int1 %>% 
          filter(period == coupe[t]) 
          clim_int2 <- clim_int1 %>% 
          filter(period == coupe[t]) 
   
          for (r in 1:nrun){
          # indicator value extracting
          array_prev[,j,r,t] <- as.vector(unlist(prev_int2 %>% filter(climatscenario == r) %>% select(indicatorvalue)))
          array_clim[,j,r,t] <- as.vector(unlist(clim_int2 %>% filter(climatscenario == r) %>% select(indicatorvalue)))
          }
        }
      }
    
      nom_ref <- paste0("yield_",culture,b,"_ref.RData")
      nom_prev <- paste0("yield_",culture,b,"_prev.RData")
      nom_clim <- paste0("yield_",culture,b,"_clim.RData")
      
      save(array_obs, file = file.path(dir_data, "extract", nom_ref))
      save(array_prev, file = file.path(dir_data, "extract", nom_prev))
      save(array_clim, file = file.path(dir_data, "extract", nom_clim))
  } 
}
stopCluster(cl)

tictoc::toc()

```

## Extracting periodic indicator values = NOT CROP SPECIFIC

For each indicator, values are stored in 3 multi-dimensional arrays: one per climat type (reference, prevision, climatology)
Reference array has 3 dimension: grid+year+t
Prevision/climatology arrays have 4 dimensions: grid+year+run+t
t= Q1...Q24

```{r, echo=FALSE}
indic_period <- c("DRAIN", "ET") # issues working with other indicators

# generate random year series
# rand_year <- list()
# for (b in 1:nboot){
#    rand_year[[b]] <- sample(1:nan, nan, replace = TRUE) 
#  }
#  save(rand_year, file = file.path(dir_data, "extract", "years.RData"))

# array setting x*year(*run)*t
load(file = file.path(dir_data, "extract", "years.RData"))

tictoc::tic() 

                                       ####################### PERIODIC #######################

for (indicateur in indic_period){

   # indicator filtering
      ind_data <- data_period %>% 
        filter(indicator == indicateur)
      
      ngrids_ind <- length(unique(ind_data[,"cellnum"]))
      
      lat <- unique(ind_data[,"lat"]) 
      save(lat, file = file.path(dir_data, "extract", paste0("lat_",indicateur,".RData")))
      lon <- unique(ind_data[,"lon"]) 
      save(lon, file = file.path(dir_data, "extract", paste0("lon_",indicateur,".RData")))

        # climat type filtering
      obs_data <- ind_data %>% 
        filter(climattype == "REF") 
      
      prev_data <- ind_data %>% 
        filter(climattype == "PS") 
      
      clim_data <- ind_data %>% 
        filter(climattype == "CLIMATO") 
      

  # extracting data
  cl <- makeCluster(no_core)
  registerDoParallel(cl)
  
  foreach(b=1:nboot, .packages="tidyverse") %dopar%  { # loop on bootstrap samples
    array_obs <- array(NA, dim=c(ngrids_ind, nan, ndimT_period))
    array_prev <- array(NA, dim=c(ngrids_ind, nan, nrun, ndimT_period))
    array_clim <- array(NA, dim=c(ngrids_ind, nan, nrun, ndimT_period))
  
      for (j in 1:nan){
        y <- rand_year[[b]][j]
        
        obs_int <- obs_data %>% 
        filter(year_ == y) 
        prev_int1 <- prev_data %>% 
        filter(year_ == y) 
        clim_int1 <- clim_data %>% 
        filter(year_ == y) 
        
        for (t in 1:ndimT_period){
          array_obs[,j,t] <- as.vector(unlist(obs_int %>% filter(period == dimT_period[t]) %>% select(indicatorvalue)))
          
          prev_int2 <- prev_int1 %>% 
          filter(period == dimT_period[t]) 
          clim_int2 <- clim_int1 %>% 
          filter(period == dimT_period[t]) 
   
          for (r in 1:nrun){
          # indicator value extracting
          array_prev[,j,r,t] <- as.vector(unlist(prev_int2 %>% filter(climatscenario == r) %>% select(indicatorvalue)))
          array_clim[,j,r,t] <- as.vector(unlist(clim_int2 %>% filter(climatscenario == r) %>% select(indicatorvalue)))
          }
        }
      }
    
      nom_ref <- paste0(indicateur,b,"_ref.RData")
      nom_prev <- paste0(indicateur,b,"_prev.RData")
      nom_clim <- paste0(indicateur,b,"_clim.RData")
      
      save(array_obs, file = file.path(dir_data, "extract", nom_ref))
      save(array_prev, file = file.path(dir_data, "extract", nom_prev))
      save(array_clim, file = file.path(dir_data, "extract", nom_clim))
  } 

stopCluster(cl)
}
tictoc::toc()

```
