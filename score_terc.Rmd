---
title: "Probabilistic scoring regarding terciles"
output: html_document
---

```{r setup, include=FALSE}
dir_data <- "D:/HOME/ekamir/scoring_medscope/data/stics" 
dir_plot <- "D:/HOME/ekamir/scoring_medscope/figure" 

library(easyVerification)
library(verification)
library(dplyr)
library(stats)
library(SpecsVerification)
library(s2dverification)
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
library(readr)
library(purrr)

no_core <- 6
ev <-3 

nboot <- 100
indicatOrs <- c("grassyieldC1C2_", "bilanhydr")
quinzn <- 9:20 # selected quinzaines de [9;20]

```

                                            ### NOT CROP SPECIFIC ###
                                            
                                            
## Gridded scores

Scores computed for each grid separately.
Indicators are assessed on a 28 days time window and over the whole season

```{r}

tictoc::tic()

for (indicateur in indicatOrs){
  
  cl <- makeCluster(no_core)
  registerDoParallel(cl)

foreach(b=1:nboot, .packages = 'easyVerification') %dopar%  { # loop on bootstrap samples

  nom_ref <- paste0(indicateur,b,"_ref.RData")
  nom_prev <- paste0(indicateur,b,"_prev.RData")

  load(file = file.path(dir_data, "extract", nom_ref))
  load(file = file.path(dir_data, "extract", nom_prev))
  
  ngrids <- dim(array_obs)[1]
  ndimT <- dim(array_obs)[3]

  scoreprob_seas_ps <- array (NA, dim=c(ngrids,e))
    
  # seasonal: WARNING WITH AGREGATION METHOD!!!!
  if (indicateur=="bilanhydr"){
  seas_obs <- apply(array_obs[,,quinzn],c(1,2), sum)
  seas_prev <- apply(array_prev[,,,quinzn],c(1,2,3), sum)
  }
  else {seas_obs <- array_obs; seas_prev <- array_prev}
  
  scoreprob_seas_ps[,1] <- veriApply("EnsRoca", fcst=seas_prev, obs=seas_obs, prob=1:2/3, parallel = TRUE)$cat1 
  scoreprob_seas_ps[,2] <- veriApply("EnsRoca", fcst=seas_prev, obs=seas_obs, prob=1:2/3, parallel = TRUE)$cat3 
   
  nom_prevseas <- paste0(indicateur, b,"scoretercseason_grid_prev.RData")

  save(scoreprob_seas_ps, file = file.path(dir_data, "score", nom_prevseas))

  }
  
stopCluster(cl)

}

tictoc::toc()



```

                                             ### NOT CROP SPECIFIC ###
    
    
## Box-agregated scores

Aggregation computed using latitude weighting

```{r}
tictoc::tic()

for (indicateur in indicatOrs){

  list_boot2 <- list()
  
  load(file = file.path(dir_data, "extract", paste0("lat_",indicateur,".RData")))

  for (b in 1:nboot){
    
    nom_prevseas <- paste0(indicateur,b,"_seasterc_prev.RData")
    nom_refseas <- paste0(indicateur,b,"_seasterc_obs.RData")
    load(file = file.path(dir_data, "extract", nom_prevseas))
    load(file = file.path(dir_data, "extract", nom_refseas))
    vect_event2 <- vector()
    for (e in 1:3){ #LT,MT,HT
      
      vect_event2[e] <- score_boite_prob(seasprob_ps, seasbin_ref, lat, nb_bin = 10, e)$AUC # seasonal 
  
      }
 
   list_boot2[[b]] <- vect_event2 # seasonal 
  
  }
 
  nom_seas <- paste0(indicateur,"boxterc_seas.RData")
  save(list_boot2, file = file.path(dir_data, "score", nom_seas))

}

tictoc::toc()


#roc.plot(x = seasbin_ref[12,,1], pred = seasprob_ps[12,,1], threshold = seq(0,1, 0.2)) 

```


## Box-agregated score analysis

Transform lists in a more handy format

```{r}

for (indicateur in indicatOrs){
  
   # season
  nom_ps <- paste0(indicateur,"boxterc_seas.RData")
  load(file = file.path(dir_data, "score", nom_ps))
  
  sum_seas <- apply(array(unlist(list_boot2) , c(ev,nboot)), 1, mean, na.rm = T)
  
  nom_seas <- paste0(indicateur,"avboxterc_seas.csv")
  write_csv(as.data.frame(sum_seas), file.path(dir_data, "score", nom_seas))
  
}

```
## Box score significance test

Wilcoxon test with H0: AUC non supérieure à 0.5

```{r}
indicateur <- "bilanhydr"
indicateur <- "DRAIN"

   # season
  nom_seas <- paste0(indicateur,"boxterc_seas.RData")
  load(file = file.path(dir_data, "score", nom_seas))
  
  boxboot <- array(unlist(list_boot2) , c(ev,nboot))
  
   wilcox.test(boxboot[1,], mu = 0.5, alternative = "greater", conf.level = 0.95, na.action = na.omit)$p.value
   wilcox.test(boxboot[3,], mu = 0.5, alternative = "greater", conf.level = 0.95, na.action = na.omit)$p.value


```


